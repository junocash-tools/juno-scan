services:
  junocashd:
    container_name: junoscan-junocashd
    build:
      context: .
      dockerfile: docker/junocashd/Dockerfile
      args:
        # Pinned commit from Juno Cash release v0.9.7.
        JUNOCASH_COMMIT: eaaeb5a85
    command:
      - -regtest
      - -server=1
      - -txindex=1
      - -daemon=0
      - -listen=0
      - -printtoconsole=1
      - -datadir=/data
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0/0
      - -rpcport=8232
      - -rpcuser=rpcuser
      - -rpcpassword=rpcpass
      - -zmqpubhashblock=tcp://0.0.0.0:28332
    ports:
      - 18232:8232
      - 28332:28332
    volumes:
      - junocashd-data:/data
    healthcheck:
      test:
        [
          "CMD",
          "junocash-cli",
          "-regtest",
          "-datadir=/data",
          "-rpcuser=rpcuser",
          "-rpcpassword=rpcpass",
          "-rpcport=8232",
          "getblockcount",
        ]
      interval: 2s
      timeout: 5s
      retries: 60

  postgres:
    container_name: junoscan-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: junoscan
      POSTGRES_PASSWORD: junoscan
      POSTGRES_DB: junoscan
    ports:
      - 15432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U junoscan"]
      interval: 2s
      timeout: 2s
      retries: 60

  mysql:
    container_name: junoscan-mysql
    image: mysql:8.4
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: junoscan
      MYSQL_USER: junoscan
      MYSQL_PASSWORD: junoscan
    ports:
      - 13306:3306
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent"]
      interval: 2s
      timeout: 5s
      retries: 60

  nats:
    container_name: junoscan-nats
    image: nats:2.10-alpine
    ports:
      - 14222:4222

  rabbitmq:
    container_name: junoscan-rabbitmq
    image: rabbitmq:3.13-management-alpine
    ports:
      - 25672:5672
      - 15672:15672

  kafka:
    container_name: junoscan-kafka
    image: bitnami/kafka:3.7
    ports:
      - 19092:9092
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@junoscan-kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:19092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      ALLOW_PLAINTEXT_LISTENER: "yes"

volumes:
  junocashd-data:

