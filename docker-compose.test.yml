services:
  junocashd:
    container_name: junoscan-junocashd
    build:
      context: .
      dockerfile: docker/junocashd/Dockerfile
      args:
        JUNOCASH_VERSION: 0.9.7
    command:
      - -regtest
      - -server=1
      - -txindex=1
      - -daemon=0
      - -listen=0
      - -printtoconsole=1
      - -datadir=/data
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0/0
      - -rpcport=8232
      - -rpcuser=rpcuser
      - -rpcpassword=rpcpass
      - -zmqpubhashblock=tcp://0.0.0.0:28332
    ports:
      - 28232:8232
      - 28332:28332
    volumes:
      - junocashd-data:/data
    healthcheck:
      test:
        [
          "CMD",
          "junocash-cli",
          "-regtest",
          "-datadir=/data",
          "-rpcuser=rpcuser",
          "-rpcpassword=rpcpass",
          "-rpcport=8232",
          "getblockcount",
        ]
      interval: 2s
      timeout: 5s
      retries: 60

  postgres:
    container_name: junoscan-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: junoscan
      POSTGRES_PASSWORD: junoscan
      POSTGRES_DB: junoscan
    ports:
      - 15432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U junoscan"]
      interval: 2s
      timeout: 2s
      retries: 60

  mysql:
    container_name: junoscan-mysql
    image: mysql:8.4
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: junoscan
      MYSQL_USER: junoscan
      MYSQL_PASSWORD: junoscan
    ports:
      - 13306:3306
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent"]
      interval: 2s
      timeout: 5s
      retries: 60

  nats:
    container_name: junoscan-nats
    image: nats:2.10-alpine
    ports:
      - 14222:4222

  rabbitmq:
    container_name: junoscan-rabbitmq
    image: rabbitmq:3.13-management-alpine
    ports:
      - 25672:5672
      - 15672:15672

  kafka:
    container_name: junoscan-kafka
    image: redpandadata/redpanda:v23.3.17
    ports:
      - 19092:9092
    command:
      - redpanda
      - start
      - --overprovisioned
      - --node-id=0
      - --check=false
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr=PLAINTEXT://127.0.0.1:19092

volumes:
  junocashd-data:
